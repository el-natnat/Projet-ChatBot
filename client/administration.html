<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <title>Administration des Bots</title>
    <link rel="stylesheet" type="text/css" href="style.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">

    <script>
        document.addEventListener('DOMContentLoaded', init);

        let ChatBotListElt;

        var idaremplacer=-1;


        //Initialise les variables et elements de la pages, notamment les listeners
        function init() {

            document.getElementById("tokenDiv").style.display = "none";

            ChatBotListElt = document.getElementById("ChatBotListUL");
            boxDiscord = document.getElementById("discord");
            boxDiscord.addEventListener("click", () => afficher());

            reloadList();
            

            modal = document.getElementById("newChatBotModal");

            

            fermerModale = document.getElementById("fermerModale"); 
            fermerModale.addEventListener("click", () => { modal.style.display = "none"; });


            newChatBotButton = document.getElementById("newChatBotButton");
            newChatBotButton.addEventListener("click", () => { modal.style.display = "block"; });

            addNewChatBotButton = document.getElementById("addNewChatBotButton");
            addNewChatBotButton.addEventListener("click", createNewChatBot);

            replaceChatBotButton = document.getElementById("replaceChatBotButton");
            replaceChatBotButton.addEventListener("click", callReplacement);

            closeReplaceChatBot = document.getElementById("closeReplaceChatBot");
            closeReplaceChatBot.addEventListener("click", annuler);

        }

        //Permet de cacher les modales
        function annuler(){
            document.getElementById('replaceChatBotModal').style.display='none';
        }

        //Recharge la liste des Bots lancés
        function reloadList() { 

            while (ChatBotListElt.firstChild) {
                ChatBotListElt.removeChild(ChatBotListElt.firstChild);
            }

            let myHeaders = new Headers();
            myHeaders.append('Content-Type', 'application/json');

            let myInit = {
                method: 'GET',
                headers: myHeaders,
                mode: 'cors',
                cache: 'default'
            };

            let myURL = "http://localhost:3001/";


            fetch(myURL, myInit)
                .then((httpResponse) => {
                    return httpResponse.json()
                })
                .then((setOfBots) => {
                    for (let bot of setOfBots) {//La requête GET doit renvoyer un setOfBots
                        ChatBotListElt.appendChild(createItem(bot)); //On ajoute les Bots à ChatBotListElt
                    }
                })
                .catch((err) => {
                    console.log(`ERROR : ${err}`);
                })


        }

        //Creer les elements pour un bot, bouton pour supprimer et pour mettre a jour
        function createItem(bot) {
            let item = document.createElement("li");

            // Adding a DELETE Button
            let delBtn = document.createElement("button");
            delBtn.innerHTML = "DELETE";
            delBtn.setAttribute("onclick", `deleteBot(${bot.id})`);
            item.appendChild(delBtn);

            // Adding a REPLACE Button
            let putBtn = document.createElement("button");
            putBtn.innerHTML = "REPLACE";
            putBtn.setAttribute("onclick", `replaceBot(${bot.id})`);
            item.appendChild(putBtn);

            item.innerHTML += ` ${bot.name}`;
            item.innerHTML += ` (${bot.cerveau})`;

            if (bot.discord) {
                item.innerHTML += ` - Discord activé`;
            }


            return item;
        }

        //appel au serveur pour supprimer un bot
        function deleteBot(botId) {
            console.log(`deleting bot with Id ${botId}`);

            let myHeaders = new Headers();
            myHeaders.append('Content-Type', 'application/json');
            let payload = {
                //name: inputTitle.value,
            };
            let myBody = JSON.stringify(payload);
            let myInit = {
                method: 'DELETE',
                headers: myHeaders,
                mode: 'cors',
                cache: 'default',
                body: myBody
            };
            let myURL = `http://localhost:3001/${botId}`;

            //launch the request
            fetch(myURL, myInit)
                .then((httpResponse) => {
                    return httpResponse.text();
                })
                .then((responseBody) => {
                    reloadList();// don't forget to reload
                    console.log(`response is ${responseBody}`);
                })
                .catch((err) => {
                    console.log(`ERROR : ${err}`);
                })
        }


        //Affiche la modale pour mettre à jour un bot
        function replaceBot(botId) {
            console.log(`replacement of bot with Id ${botId}`);

            let modal = document.getElementById("replaceChatBotModal");
            modal.style.display = "block";
            
            idaremplacer=botId;

        }

        //Appel au serveur pour remplacer un bot
        function callReplacement(){

            console.log(`replacing bot with Id ${idaremplacer}`);
            var inputBrain = document.querySelector('input[name="choix_cerveau"]:checked');
            let myHeaders = new Headers();
            myHeaders.append('Content-Type', 'application/json');
        
            let inputTitle2 = document.getElementById("inputTitle2");
            tokenDiscord = document.getElementById("tokenDiscord");

            console.log("tic");
            console.log(inputTitle2.value);
            console.log("tac");

            let payload = {
                id:idaremplacer,
                name: inputTitle2.value,
                cerveau: inputBrain.id,
                discord: boxDiscord.checked,
                token: tokenDiscord.value
            };
            let myBody = JSON.stringify(payload);
            let myInit = {
                method: 'PUT',
                headers: myHeaders,
                mode: 'cors',
                cache: 'default',
                body: myBody
            };
            let myURL = `http://localhost:3001/${idaremplacer}`;
            console.log(myBody);

            //launch the request
            fetch(myURL, myInit)
                .then((httpResponse) => {
                    return httpResponse.text();
                })
                .then((responseBody) => {
                    reloadList();// don't forget to reload
                    console.log(`response is ${responseBody}`);
                })
                .catch((err) => {
                    console.log(`ERROR : ${err}`);
                })
        }
           
        //Affiche la case pour entrer le token Discord si la case Discord est cochee
        function afficher() {
            if (boxDiscord.checked) {
                document.getElementById("tokenDiv").style.display = "block";

            }
            else {
                document.getElementById("tokenDiv").style.display = "none";
            }
            console.log("CLIQUER");
        }

        //Fonction appelée lorsqu'on valide le nom du ChatBot et le cerveau ont été renseigné
        function createNewChatBot() { 

            inputTitle = document.getElementById("inputTitle");
            //inputBrain = document.querySelector('input[name="choix_cerveau"]:checked');

            tokenDiscord = document.getElementById("tokenDiscord");
            var inputBrain = document.querySelector('input[name="choix_cerveau"]:checked')


            console.log("Nouveau ChatBot créé");
            console.log(inputTitle.value); // Envoie le nom du ChatBot
            console.log(boxDiscord.checked);
            console.log("Fin");
            console.log(tokenDiscord);

            console.log(inputBrain.id);
            let modal = document.getElementById("newChatBotModal");

            modal.style.display = "none";

            let myHeaders = new Headers();
            myHeaders.append('Content-Type', 'application/json');

            let payload = {
                name: inputTitle.value,
                cerveau: inputBrain.id,
                discord: boxDiscord.checked,
                token: tokenDiscord.value

            };
            let myBody = JSON.stringify(payload);
            let myInit = {
                method: 'POST',
                headers: myHeaders,
                mode: 'cors',
                cache: 'default',
                body: myBody
            };
            let myURL = "http://localhost:3001/"; //URL du serveur qui va être lancé



            //launch the request
            fetch(myURL, myInit)
                .then((httpResponse) => {
                    return httpResponse.text();
                })
                .then((responseBody) => {
                    reloadList();
                    //clear fields
                    inputTitle.value = "";

                    console.log(`response is ${responseBody}`);
                })
                .catch((err) => {
                    console.log(`ERROR : ${err}`);
                })

            console.log("Requête POST envoyée avec succès");
            afficher();
        }



    </script>

</head>

<body>
    <h1> Interface d'administration des Bots</h1>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item"><a class="nav-link" href="./administration.html">Gestion des Bots</a></li>
            <li><a class="nav-link" href="./communicate.html">Communiquer avec les Bots</a></li>
        </ul>
    </nav>

    <!-- Liste des ChatBots à afficher -->
    <ul id="ChatBotListUL">
    </ul>



    <button id="newChatBotButton">Ajouter un nouveau ChatBot</button>

    <!-- Modal pour la création d'un bot-->
    <div id="newChatBotModal" class="modal">

        <div class="modal-content">

            <header>
                <h1>Créer un nouveau ChatBot</h1>
            </header>
            <p>
                <label for="inputTitle" x>Nom du ChatBot:</label>
                <input type="text" id="inputTitle" name="name"></input>

            </p>

            <p>
                <label>Choix du cerveau: (cerveau 1 est choisi par défaut)</label> <br>
                <input id="cerveau1" type="radio" name="choix_cerveau" />
                <label> Cerveau 1 </label> <br />
                <input id="cerveau2" type="radio" name="choix_cerveau" />
                <label> Cerveau 2 </label><br />

            </p>
            <p>
                <label> Activer l'implémentation Discord : </label>
                <input type="checkbox" id="discord" name="discord"> <br />

            <div id="tokenDiv">
                <label for="inputDiscord">Token Discord:</label>
                <input type="text" id="tokenDiscord" name="tokenDiscord"></input>
            </div>
            </p>

            <button id="fermerModale">Annuler</button>

            <button id="addNewChatBotButton">Ajouter le ChatBot</button><br>
        </div>

    </div>

    <!-- Modal pour le replace d'un bot-->
    <div id="replaceChatBotModal" class="modal">

        <div class="modal-content">
            <header>
                <h1>Modifier un ChatBot</h1>
            </header>
            <p>
                <label for="inputTitle2">Nom du ChatBot:</label>
                <input type="text" id="inputTitle2" name="name"></input>

            </p>

            <p>
                <label>Choix du cerveau: </label>
                <input type="radio" name="choix_cerveau" id="cerveau1" checked />
                <label> Cerveau 1 </label> <br />
                <input id="cerveau2" type="radio" name="choix_cerveau" />
                <label> Cerveau 2 </label><br />

            </p>


            <!-- On réutilise le bouton addnewChatButton ??-->
            <button id="replaceChatBotButton">Remplacer le ChatBot</button> <br>
            <button id="closeReplaceChatBot"> Annuler </button>
        </div>

    </div>

   



</body>